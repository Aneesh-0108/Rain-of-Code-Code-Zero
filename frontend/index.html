<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Campus Connect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./style.css" />
    <!-- Firebase (modular) via CDN -->
    <script type="module">
        // Preload Firebase modules (optional)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    </script>
</head>

<body>
    <header class="app-header">
        <div class="logo">Campus Connect</div>
        <nav class="nav-actions">
            <button id="loginBtn" class="btn primary">Login</button>
            <button id="logoutBtn" class="btn" style="display:none;">Logout</button>
        </nav>
    </header>

    <main class="container">
        <section id="userInfo" class="panel hidden"></section>

        <section id="createSection" class="panel hidden">
            <h2>Create Event</h2>
            <form id="createForm">
                <div class="field">
                    <label>Title</label>
                    <input name="title" required />
                </div>
                <div class="field">
                    <label>Start Time</label>
                    <input name="startTime" type="datetime-local" required />
                </div>
                <div class="field">
                    <label>End Time</label>
                    <input name="endTime" type="datetime-local" required />
                </div>
                <div class="field">
                    <label>Capacity</label>
                    <input name="capacity" type="number" min="1" value="30" required />
                </div>
                <div class="field">
                    <label>Description</label>
                    <textarea name="description" rows="2"></textarea>
                </div>
                <div class="actions">
                    <button type="submit" class="btn primary">Save</button>
                    <button type="button" id="cancelCreate" class="btn">Cancel</button>
                </div>
                <div class="error-msg" id="createError" style="display:none;"></div>
            </form>
        </section>

        <section class="panel">
            <div class="panel-header">
                <h2>Events</h2>
                <div class="ics-links">
                    <a id="allIcsLink" href="#" class="link">All Events (.ics)</a>
                    <button id="OpenCreate" class="btn primary" style="margin-left: 1 rem;">+ Create Event</button>
                </div>
            </div>
            <div id="eventsLoading">Loading events...</div>
            <ul id="eventsList" class="events"></ul>
            <div id="eventsEmpty" class="empty hidden">No approved events yet.</div>
        </section>

        <section id="pendingSection" class="panel hidden">
            <h2>Pending Events (Admin)</h2>
            <ul id="pendingList" class="events"></ul>
            <div id="pendingEmpty" class="empty hidden">No pending events.</div>
        </section>

        <div id="toast" class="toast hidden"></div>
    </main>

    <footer class="footer">
        <small>Campus Connect Platform &copy; 2025</small>
    </footer>
    <script type="module">
        import { login, logout, onUserChanged } from "./js/auth.js";
        import { api } from "./js/api.js";


        window.api = api;

        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const userInfo = document.getElementById("userInfo");
        const createSection = document.getElementById("createSection");
        const createForm = document.getElementById("createForm");
        const openCreate = document.getElementById("OpenCreate");
        const cancelCreate = document.getElementById("cancelCreate");
        const eventsList = document.getElementById("eventsList");
        const eventsLoading = document.getElementById("eventsLoading");

        // ---- Login & Logout ----
        loginBtn.addEventListener("click", async () => { await login(); });
        logoutBtn.addEventListener("click", async () => { await logout(); });

        // ---- Show/Hide create event form ----
        openCreate.addEventListener("click", () => {
            createSection.classList.remove("hidden");
        });
        cancelCreate.addEventListener("click", () => {
            createSection.classList.add("hidden");
        });

        // ---- Handle auth state changes ----
        onUserChanged(async (user, token) => {
            if (user) {
                loginBtn.style.display = "none";
                logoutBtn.style.display = "inline-block";
                userInfo.classList.remove("hidden");
                userInfo.innerHTML = `<p>Logged in as ${user.email}</p>`;

                // Fetch events once logged in
                loadEvents();
            } else {
                loginBtn.style.display = "inline-block";
                logoutBtn.style.display = "none";
                userInfo.classList.add("hidden");
                eventsList.innerHTML = "";
            }
        });

        // ---- Load Events ----
        async function loadEvents() {
            eventsLoading.style.display = "block";
            eventsList.innerHTML = "";
            try {
                const events = await api.listEvents();
                eventsLoading.style.display = "none";

                if (!events.length) {
                    document.getElementById("eventsEmpty").classList.remove("hidden");
                } else {
                    document.getElementById("eventsEmpty").classList.add("hidden");
                    events.forEach(ev => {
                        const li = document.createElement("li");
                        li.textContent = `${ev.title} (${ev.startTime})`;
                        eventsList.appendChild(li);
                    });
                }
            } catch (err) {
                eventsLoading.textContent = "Failed to load events.";
            }
        }

        // ---- Handle Create Event Form ----
        createForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(createForm));
            try {
                const newEvent = await api.createEvent(data);
                console.log("Event created:", newEvent);
                createForm.reset();
                createSection.classList.add("hidden");
                loadEvents(); // refresh
            } catch (err) {
                document.getElementById("createError").textContent = err.message;
                document.getElementById("createError").style.display = "block";
            }
        });

        api.me()
            .then(user => console.log("Logged in as:", user))
            .catch(err => console.error("Auth error:", err));



    </script>



</body>

</html>